--source include/have_tianmu.inc

--disable_warnings
DROP DATABASE IF EXISTS issue1034_test;
--enable_warnings

CREATE DATABASE issue1034_test;

USE issue1034_test;

--disable_warnings

## test with enable the tianmu PRIMARY KEY index

set global tianmu_index_search=on;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=DEFAULT;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## test with disable the tianmu PRIMARY KEY index

set global tianmu_index_search=off;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=DEFAULT;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## clean test TABLE

DROP TABLE t1;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=COPY;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## test with disable the tianmu PRIMARY KEY index

set global tianmu_index_search=off;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=COPY;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## clean test TABLE

DROP TABLE t1;

## multi primary key

CREATE TABLE t1 (id int, name VARCHAR(255), age int) ENGINE=TIANMU;

ALTER TABLE t1 ADD PRIMARY KEY(id,name), ALGORITHM=DEFAULT;

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

DROP TABLE t1;

CREATE TABLE t1 (id int, name VARCHAR(255), age int) ENGINE=TIANMU;

ALTER TABLE t1 ADD PRIMARY KEY(id,name), ALGORITHM=COPY;

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

DROP TABLE t1;

## ERROR for ALGORITHM=INPLACE

CREATE TABLE t1 (id int) ENGINE=TIANMU;

--error 1845
ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=INPLACE;

DROP TABLE t1;

## test with enable the tianmu PRIMARY KEY index

set global tianmu_index_search=on;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=DEFAULT;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## test with disable the tianmu PRIMARY KEY index

set global tianmu_index_search=off;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=DEFAULT;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## clean test TABLE

DROP TABLE t1;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=COPY;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## test with disable the tianmu PRIMARY KEY index

set global tianmu_index_search=off;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=COPY;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE USING BTREE, ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## clean test TABLE

DROP TABLE t1;

## multi primary key

CREATE TABLE t1 (id int, name VARCHAR(255), age int) ENGINE=TIANMU;

ALTER TABLE t1 ADD PRIMARY KEY(id,name), ALGORITHM=DEFAULT;

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

DROP TABLE t1;

CREATE TABLE t1 (id int, name VARCHAR(255), age int) ENGINE=TIANMU;

ALTER TABLE t1 ADD PRIMARY KEY(id,name), ALGORITHM=COPY;

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

DROP TABLE t1;

## ERROR for ALGORITHM=INPLACE

CREATE TABLE t1 (id int) ENGINE=TIANMU;

--error 1845
ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=INPLACE;

DROP TABLE t1;

## test with enable the tianmu PRIMARY KEY index

set global tianmu_index_search=on;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=DEFAULT;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## test with disable the tianmu PRIMARY KEY index

set global tianmu_index_search=off;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=DEFAULT;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## clean test TABLE

DROP TABLE t1;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=COPY;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## test with disable the tianmu PRIMARY KEY index

set global tianmu_index_search=off;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=COPY;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id int PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH USING HASH, ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## clean test TABLE

DROP TABLE t1;

## multi primary key

CREATE TABLE t1 (id int, name VARCHAR(255), age int) ENGINE=TIANMU;

ALTER TABLE t1 ADD PRIMARY KEY(id,name), ALGORITHM=DEFAULT;

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

DROP TABLE t1;

CREATE TABLE t1 (id int, name VARCHAR(255), age int) ENGINE=TIANMU;

ALTER TABLE t1 ADD PRIMARY KEY(id,name), ALGORITHM=COPY;

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

DROP TABLE t1;

## ERROR for ALGORITHM=INPLACE

CREATE TABLE t1 (id int) ENGINE=TIANMU;

--error 1845
ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=INPLACE;

DROP TABLE t1;

## test with enable the tianmu PRIMARY KEY index

set global tianmu_index_search=on;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255)) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=DEFAULT;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255) PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## test with disable the tianmu PRIMARY KEY index

set global tianmu_index_search=off;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255)) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=DEFAULT;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255) PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## clean test TABLE

DROP TABLE t1;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255)) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=COPY;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255) PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## test with disable the tianmu PRIMARY KEY index

set global tianmu_index_search=off;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255)) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=COPY;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255) PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## clean test TABLE

DROP TABLE t1;

## multi primary key

CREATE TABLE t1 (id VARCHAR(255), name VARCHAR(255), age int) ENGINE=TIANMU;

ALTER TABLE t1 ADD PRIMARY KEY(id,name), ALGORITHM=DEFAULT;

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

DROP TABLE t1;

CREATE TABLE t1 (id VARCHAR(255), name VARCHAR(255), age int) ENGINE=TIANMU;

ALTER TABLE t1 ADD PRIMARY KEY(id,name), ALGORITHM=COPY;

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

DROP TABLE t1;

## ERROR for ALGORITHM=INPLACE

CREATE TABLE t1 (id VARCHAR(255)) ENGINE=TIANMU;

--error 1845
ALTER TABLE t1 ADD PRIMARY KEY(id), ALGORITHM=INPLACE;

DROP TABLE t1;

## test with enable the tianmu PRIMARY KEY index

set global tianmu_index_search=on;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255)) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=DEFAULT;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255) PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## test with disable the tianmu PRIMARY KEY index

set global tianmu_index_search=off;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255)) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=DEFAULT;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255) PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## clean test TABLE

DROP TABLE t1;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255)) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=COPY;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255) PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## test with disable the tianmu PRIMARY KEY index

set global tianmu_index_search=off;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255)) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=COPY;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255) PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE USING BTREE, ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## clean test TABLE

DROP TABLE t1;

## multi primary key

CREATE TABLE t1 (id VARCHAR(255), name VARCHAR(255), age int) ENGINE=TIANMU;

ALTER TABLE t1 ADD PRIMARY KEY(id,name), ALGORITHM=DEFAULT;

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

DROP TABLE t1;

CREATE TABLE t1 (id VARCHAR(255), name VARCHAR(255), age int) ENGINE=TIANMU;

ALTER TABLE t1 ADD PRIMARY KEY(id,name), ALGORITHM=COPY;

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

DROP TABLE t1;

## ERROR for ALGORITHM=INPLACE

CREATE TABLE t1 (id VARCHAR(255)) ENGINE=TIANMU;

--error 1845
ALTER TABLE t1 ADD PRIMARY KEY(id) USING BTREE, ALGORITHM=INPLACE;

DROP TABLE t1;

## test with enable the tianmu PRIMARY KEY index

set global tianmu_index_search=on;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255)) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=DEFAULT;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255) PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## test with disable the tianmu PRIMARY KEY index

set global tianmu_index_search=off;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255)) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=DEFAULT;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255) PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=DEFAULT;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

## clean test TABLE

DROP TABLE t1;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255)) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=COPY;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255) PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## test with disable the tianmu PRIMARY KEY index

set global tianmu_index_search=off;

## DDL no PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255)) ENGINE=TIANMU;

## ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=COPY;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## DDL has PRIMARY KEY

DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (id VARCHAR(255) PRIMARY KEY) ENGINE=TIANMU;

## DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## re ADD pk

ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH USING HASH, ALGORITHM=COPY;

## re DROP pk

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

## clean test TABLE

DROP TABLE t1;

## multi primary key

CREATE TABLE t1 (id VARCHAR(255), name VARCHAR(255), age int) ENGINE=TIANMU;

ALTER TABLE t1 ADD PRIMARY KEY(id,name), ALGORITHM=DEFAULT;

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=DEFAULT;

DROP TABLE t1;

CREATE TABLE t1 (id VARCHAR(255), name VARCHAR(255), age int) ENGINE=TIANMU;

ALTER TABLE t1 ADD PRIMARY KEY(id,name), ALGORITHM=COPY;

ALTER TABLE t1 DROP PRIMARY KEY, ALGORITHM=COPY;

DROP TABLE t1;

## ERROR for ALGORITHM=INPLACE

CREATE TABLE t1 (id VARCHAR(255)) ENGINE=TIANMU;

--error 1845
ALTER TABLE t1 ADD PRIMARY KEY(id) USING HASH, ALGORITHM=INPLACE;

DROP TABLE t1;

DROP DATABASE issue1034_test;
